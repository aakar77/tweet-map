{% load staticfiles %}

<!DOCTYPE html>
<html>
<head>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
</head>

<body>

	<div class="container">

	<!-- Fixed navbar -->
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">

        <p class="navbar-brand" style=""> Tweet Map</p>
        {% csrf_token %}
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </nav>

		<h1> <br /><br /> </h1>

		<div class="row">
      <div class="col-md-3">
        <div class="form-group">

            <form method="post" id="myform" name="myform">
                {% csrf_token %}

                <select class="form-control" id="dropdown-menu" name="dropdown-menu">
                    <option value="">Select the Topic</option>
                    {% for topic in topics %}
                        <option value="{{topic}}">{{topic}}</option>
                    {% endfor %}
                </select>
            </form>

          </div>
        </div>
        <div class="col-md-6 content">

        </div>
    </div>

    <!-- start map -->
		<div id="map" style="width:1050px;height:450px;background:blue;">

		</div>
		<!-- end map -->

     	<!-- start modal -->
     	<div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog">
              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header" style = "background-color: #2a4d6b;">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                  <p id="modal-message"> Hii</p>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
		</div>
		<!-- end modal -->

	</div>
	<!-- end container -->

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!-- Custom JS File - Application Logic
  <script src="{% static 'js/applogic.js' %}"></script> -->

  <script type="text/JavaScript">

    // Declaring Global variables
    var plotDict = [];

    var map;

    var geocoder;
    var resulObj = null;
    var image = "https://maps.gstatic.com/intl/en_ALL/mapfiles/markers2/measle.png";
<<<<<<< HEAD

    // This will be triggered on change event of dropdown-menu
    // Form will be submited
    //var requestInterval = setInterval(postData, 10000);
=======


    // -------------------------------------

    // This will be triggered on change event of dropdown-menu
    // Form will be submited


    var requestInterval = setInterval(postData, 10000);
>>>>>>> b9d15caa242b0bdc135a0ea3dc1656957c7cb2ae

    $(document).ready(function() {
      $('#dropdown-menu').on('change', function() {
          postData();
        //document.forms['myform'].submit();
     });
    });

	function postData(){

	      var search = $("#dropdown-menu").val();

	      if(search != null && search != undefined){

	        $.ajax({
	          url: '/search',
	          type: 'POST',
	          data: {
	            'search': search,
	            'csrfmiddlewaretoken': '{{ csrf_token }}',
	          },
	          dataType: 'json',
	          success: function (data) {

	            console.log("succes");
				console.log(data)
	            if(data.status == 'true'){
	              plotData(data.tweet)
	            }
	          },
	          error: function() {
	            console.log("failure");
	          }
	        });
	      }
	    }

    // This functions is used to plot the marker on google map. It returns the marker object
    function plotMarker(Latitude, Longitude, map){

      // Setting the marker object with the map, latitude and longitude data
    	var marker = new google.maps.Marker({
    		position: {lat: Latitude, lng: Longitude},
    		map: map,
        icon: image
    	});

    	return(marker);
    }

<<<<<<< HEAD
    // Function for initialization of Google MAP
    function myMap() {

      // Image for the pushpin Object
      var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';

      var mapCanvas = document.getElementById("map");
      var mapOptions = {
        center: new google.maps.LatLng(37.09024, -95.712891),
        disableDefaultUI: true,
        zoom: 2 ,
        styles: [
              {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
              {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
              {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
              {
                featureType: 'water',
                elementType: 'geometry',
                stylers: [{color: '#17263c'}]
              },
              {
                featureType: 'poi',
                elementType: 'labels.text.fill',
                stylers: [{color: '#d59563'}]
              },
              {
                featureType: 'water',
                elementType: 'labels.text.fill',
                stylers: [{color: '#515c6d'}]
              },
              {
                featureType: 'water',
                elementType: 'labels.text.stroke',
                stylers: [{color: '#17263c'}]
              }
            ],

=======
    // This function is used for searching the location by name and returns lat long object

  /*  function geocodeAddress(address) {

      geocoder.geocode({'address': address}, function(results, status) {

        var resultObj = null;

        if (status == google.maps.GeocoderStatus.OK) {

          // Setting the resultant object

          resultObj = {'lat': results[0].geometry.location.lat(), 'long':  results[0].geometry.location.lng()};

        } else {

        }
        return resultObj;
      });
    }
*/
    // Function for initialization of Google MAP
    function myMap() {

      // Image for the pushpin Object
      var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';

      var mapCanvas = document.getElementById("map");
      var mapOptions = {
        center: new google.maps.LatLng(37.09024, -95.712891),
        disableDefaultUI: true,
        zoom: 2 ,
        styles: [
              {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
              {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
              {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
              {
                featureType: 'water',
                elementType: 'geometry',
                stylers: [{color: '#17263c'}]
              },
              {
                featureType: 'poi',
                elementType: 'labels.text.fill',
                stylers: [{color: '#d59563'}]
              },
              {
                featureType: 'water',
                elementType: 'labels.text.fill',
                stylers: [{color: '#515c6d'}]
              },
              {
                featureType: 'water',
                elementType: 'labels.text.stroke',
                stylers: [{color: '#17263c'}]
              }
            ],

>>>>>>> b9d15caa242b0bdc135a0ea3dc1656957c7cb2ae
          };

      //geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(mapCanvas, mapOptions);
    }

<<<<<<< HEAD
=======
    // Function for generating random latitude and longitude
    function getRandomInRange(from, to, fixed) {

      return (Math.random() * (to - from) + from).toFixed(fixed) * 1;
      // .toFixed() returns string, so ' * 1' is a trick to convert to number
    }



>>>>>>> b9d15caa242b0bdc135a0ea3dc1656957c7cb2ae
    function plotData(tweets){

      // Storing the tweetData.tweet
      var tweetsArray = tweets;
	  console.log(tweetsArray)
      // If there are tweets for the given topic Iterate
      if(tweetsArray.length > 0){
		  
          // Creating marker and InfoWindow for the Google Map Objects
          var marker = null, i;
          var infowindow = new google.maps.InfoWindow();
<<<<<<< HEAD
		  console.log("Tweets array is there sa.")
=======


>>>>>>> b9d15caa242b0bdc135a0ea3dc1656957c7cb2ae
          // Iterating over the tweetsArray
          for(i = 0; i<tweetsArray.length; i++){

            // Getting the Tweet data
            var tweet = tweetsArray[i];

            if(tweet.hasOwnProperty('latitude')){
              // console.log("Lat: "+tweet.lat+"Log: "+tweet.long);
              // Creating a Google Map marker object

              // Setting the image URL to measle_blue;
              image= "https://maps.gstatic.com/intl/en_us/mapfiles/markers2/measle_blue.png";
              marker = plotMarker(tweet.latitude,tweet.longitude, map);
            }

<<<<<<< HEAD
=======
            /*
            if(tweet.hasOwnProperty('location')){

              // Setting image to yellow
              image = "https://storage.googleapis.com/support-kms-prod/SNP_2752063_en_v0";


              geocodeAddress(tweet.location);

              console.log(resultObj+"inside");

              if(resultObj.hasOwnProperty('lat')){

                marker = plotMarker(resultObj.lat, resultObj.long, map);
                console.log("In location search by name");
              }
            }
            else{

              // These are tweets which are not having any co-ordinates.
              // Not having any location Name

              // Setting the image URL to red_color;
              image = "https://storage.googleapis.com/support-kms-prod/SNP_2752125_en_v0";

              lat = getRandomInRange(-90,180, 3);
              long = getRandomInRange(-90,180, 4);

              marker = plotMarker(lat,long, map);

            } */


>>>>>>> b9d15caa242b0bdc135a0ea3dc1656957c7cb2ae
            if(marker != null){
              // Code for adding the infowindow corresponding to the given marker
              google.maps.event.addListener(marker, 'click',

                (function(marker, i)
                {
                  return function()
                  {
                    // Setting the content of infowindow

                      infowindow.setContent(tweet.handle + tweet.text);

                      infowindow.open(map, marker);
                  }
                }
              )(marker, i));
            }
          }
<<<<<<< HEAD
          //$('#content').html('<div class=alert alert-success> <strong>'+tweetsArray.length+'</strong></div>');

          // Just logging the tweetData receieved
=======

          //$('#content').html('<div class=alert alert-success> <strong>'+tweetsArray.length+'</strong></div>');


          // Just logging the tweetData receieved
          //document.getElementById("content").innerHTML = "";

          // Just logging the tweetData receieved
>>>>>>> b9d15caa242b0bdc135a0ea3dc1656957c7cb2ae
          console.log(tweetsArray.length);
        }
    }
    $('.dropdown-menu').on('click', 'a', function(e){

      // 'this' is the clicked anchor

      var text = this.text;
      var href = this.href;

      alert(text);

      // here add to local storage;
    });

  </script>


  <!-- Google Map API call -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIWnwGb9WRladk_47LmMTH6cte9eC6Ob4&callback=myMap"></script>

</body>
</html>
